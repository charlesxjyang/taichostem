import{r as a,j as e,c as Rt,R as It}from"./index-m6ZVwKD-.js";const Lt="http://127.0.0.1:8000",Ot=2e3;function _t({className:l}){const[w,o]=a.useState(!1);return a.useEffect(()=>{const v=async()=>{try{const k=await(await fetch(`${Lt}/health`,{method:"GET",signal:AbortSignal.timeout(1500)})).json();o(k.status==="ok")}catch{o(!1)}};v();const N=setInterval(v,Ot);return()=>clearInterval(N)},[]),e.jsxs("div",{className:`backend-status ${l??""}`,children:[e.jsx("span",{className:`backend-status-dot ${w?"connected":"disconnected"}`}),e.jsxs("span",{className:"backend-status-text",children:["Backend: ",w?"Connected":"Disconnected"]})]})}function Wt(l){const w={name:"",fullPath:"",children:new Map,dataset:null};for(const o of l){const v=o.path.split("/").filter(Boolean);let N=w;for(let b=0;b<v.length;b++){const k=v[b],m=b===v.length-1;N.children.has(k)||N.children.set(k,{name:k,fullPath:"/"+v.slice(0,b+1).join("/"),children:new Map,dataset:null}),N=N.children.get(k),m&&(N.dataset=o)}}return w}function tt({node:l,depth:w,selectedPath:o,onSelect:v}){const[N,b]=a.useState(!0),k=l.children.size>0,m=l.dataset!==null,P=o===l.fullPath,S=()=>{m?v(l.fullPath):k&&b(!N)},D=_=>_.join(" x ");return e.jsxs("div",{className:"tree-node",children:[e.jsxs("div",{className:`tree-node-row ${m?"dataset":"group"} ${P?"selected":""}`,style:{paddingLeft:`${w*16+8}px`},onClick:S,children:[k&&!m&&e.jsx("span",{className:"tree-expand-icon",children:N?"â–¼":"â–¶"}),!k&&!m&&e.jsx("span",{className:"tree-expand-icon"}),m&&e.jsx("span",{className:"tree-expand-icon",children:"â–¡"}),e.jsx("span",{className:"tree-node-name",children:l.name}),m&&l.dataset&&e.jsxs("span",{className:"tree-node-meta",children:[e.jsxs("span",{className:"tree-node-shape",children:["[",D(l.dataset.shape),"]"]}),e.jsx("span",{className:"tree-node-dtype",children:l.dataset.dtype}),l.dataset.is_4d&&e.jsx("span",{className:"tree-node-badge",children:"4D-STEM"})]})]}),k&&N&&e.jsx("div",{className:"tree-children",children:Array.from(l.children.values()).map(_=>e.jsx(tt,{node:_,depth:w+1,selectedPath:o,onSelect:v},_.fullPath))})]})}function Bt({isOpen:l,datasets:w,filename:o,onSelect:v,onCancel:N}){const[b,k]=a.useState(null),m=a.useMemo(()=>Wt(w),[w]);if(!l)return null;const P=()=>{b&&v(b)},S=D=>{D.target===D.currentTarget&&N()};return e.jsx("div",{className:"modal-backdrop",onClick:S,children:e.jsxs("div",{className:"modal-container",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{className:"modal-title",children:"Select 4D-STEM Dataset"}),e.jsx("span",{className:"modal-filename",children:o})]}),e.jsx("div",{className:"modal-body",children:e.jsx("div",{className:"tree-container",children:m.children.size>0?Array.from(m.children.values()).map(D=>e.jsx(tt,{node:D,depth:0,selectedPath:b,onSelect:k},D.fullPath)):e.jsx("div",{className:"tree-empty",children:"No datasets found in file"})})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"modal-button cancel",onClick:N,children:"Cancel"}),e.jsx("button",{className:"modal-button primary",onClick:P,disabled:!b,children:"Load Selected"})]})]})})}function et(l){return l.join("Ã—")}function st({node:l,depth:w,selectedPath:o,loadingPath:v,expandedPaths:N,onToggleExpand:b,onSelect:k}){const m=l.type==="group",P=l.type==="dataset",S=l.is_4d===!0,D=N.has(l.path),_=o===l.path,R=v===l.path,W=m&&l.children&&l.children.length>0,X=a.useCallback(()=>{m&&W?b(l.path):P&&S&&k(l.path)},[m,P,S,W,l.path,b,k]),ye=a.useCallback(J=>{J.stopPropagation(),m&&W&&b(l.path)},[m,W,l.path,b]);let te;return m?te=D?"ðŸ“‚":"ðŸ“":S?te="ðŸ“‹":te="ðŸ–¼",e.jsxs("div",{className:"tree-node-wrapper",children:[e.jsxs("div",{className:`tree-node ${P&&!S?"disabled":""} ${_?"selected":""} ${R?"loading":""}`,style:{paddingLeft:`${w*16+8}px`},onClick:X,title:P?`${l.path}
${l.shape?et(l.shape):""}
${l.dtype||""}`:l.path,children:[e.jsx("span",{className:`tree-chevron ${W?"":"hidden"}`,onClick:ye,children:D?"â–¼":"â–¶"}),e.jsx("span",{className:"tree-icon",children:te}),e.jsx("span",{className:`tree-name ${S?"is-4d":""}`,children:l.name}),S&&e.jsx("span",{className:"tree-4d-badge",children:"4D"}),P&&l.shape&&e.jsxs("span",{className:"tree-shape",children:["(",et(l.shape),")"]}),R&&e.jsx("span",{className:"tree-loading-spinner"})]}),m&&D&&l.children&&e.jsx("div",{className:"tree-children",children:l.children.map(J=>e.jsx(st,{node:J,depth:w+1,selectedPath:o,loadingPath:v,expandedPaths:N,onToggleExpand:b,onSelect:k},J.path))})]})}function at(l){return l.type==="dataset"&&l.is_4d?!0:l.type==="group"&&l.children?l.children.some(at):!1}function nt(l,w=new Set){if(l.type==="group"&&l.children){l.children.some(at)&&w.add(l.path);for(const o of l.children)nt(o,w)}return w}function Ht({collapsed:l,onToggleCollapse:w,fileTree:o,selectedDatasetPath:v,isLoading:N,loadingDatasetPath:b,onDatasetSelect:k,onRefresh:m}){const[P,S]=a.useState(new Set(["/"]));a.useEffect(()=>{if(o!=null&&o.root){const R=nt(o.root);R.add("/"),S(R)}else S(new Set(["/"]))},[o]);const D=a.useCallback(R=>{S(W=>{const X=new Set(W);return X.has(R)?X.delete(R):X.add(R),X})},[]),_=a.useCallback(()=>{m()},[m]);return l?e.jsx("div",{className:"file-browser-sidebar collapsed",children:e.jsx("button",{className:"file-browser-expand-btn",onClick:w,title:"Expand file browser",children:e.jsx("span",{className:"file-browser-expand-icon",children:"ðŸ“"})})}):e.jsxs("div",{className:"file-browser-sidebar",children:[e.jsxs("div",{className:"file-browser-header",children:[e.jsx("span",{className:"file-browser-title",children:"EXPLORER"}),e.jsxs("div",{className:"file-browser-header-actions",children:[e.jsx("button",{className:"file-browser-refresh-btn",onClick:_,title:"Refresh file structure",disabled:!o||N,children:"â†»"}),e.jsx("button",{className:"file-browser-collapse-btn",onClick:w,title:"Collapse file browser",children:"â€¹"})]})]}),e.jsx("div",{className:"file-browser-content",children:o?e.jsxs("div",{className:"file-browser-tree",children:[e.jsxs("div",{className:"tree-node tree-root",onClick:()=>D("/"),children:[e.jsx("span",{className:"tree-chevron",children:P.has("/")?"â–¼":"â–¶"}),e.jsx("span",{className:"tree-icon",children:"ðŸ“„"}),e.jsx("span",{className:"tree-name tree-filename",children:o.filename})]}),P.has("/")&&o.root.children&&e.jsx("div",{className:"tree-children",children:o.root.children.map(R=>e.jsx(st,{node:R,depth:1,selectedPath:v,loadingPath:b,expandedPaths:P,onToggleExpand:D,onSelect:k},R.path))})]}):e.jsxs("div",{className:"file-browser-empty",children:[e.jsx("span",{className:"file-browser-empty-text",children:"No file open"}),e.jsx("span",{className:"file-browser-empty-hint",children:"Use File â†’ Open to load a dataset"})]})})]})}const Q="http://127.0.0.1:8000";function Vt(){const[l,w]=a.useState(null),[o,v]=a.useState(null),[N,b]=a.useState(!1),[k,m]=a.useState(null),[P,S]=a.useState(!1),[D,_]=a.useState(null),[R,W]=a.useState([]),[X,ye]=a.useState(!1),[te,J]=a.useState(null),[lt,q]=a.useState(null),[We,Y]=a.useState(null),[M,H]=a.useState(null),[y,Ce]=a.useState(null),Be=a.useRef(null),[He,le]=a.useState(null),[B,Se]=a.useState("live"),[De,pe]=a.useState(null),[$e,me]=a.useState(null),[$,Pe]=a.useState("rectangle"),[d,re]=a.useState(null),[se,xe]=a.useState(!1),[j,Z]=a.useState([]),[be,G]=a.useState(null),ie=a.useRef(null),[ce,Ve]=a.useState(!1),[ae,ge]=a.useState("display"),[x,rt]=a.useState(!1),[f,Ye]=a.useState(0),[p,Xe]=a.useState(100),[i,je]=a.useState("bf"),[I,Ue]=a.useState(20),[F,Me]=a.useState(22),[E,Fe]=a.useState(35),[T,Ee]=a.useState(40),[A,Te]=a.useState(80),[we,it]=a.useState(!0),[oe,ct]=a.useState(50),[de,ot]=a.useState("auto"),[Je,dt]=a.useState(0),[qe,ht]=a.useState(0),[Ae,ut]=a.useState(!1),[ne,ft]=a.useState(!1),[ve,Ge]=a.useState("virtual-detector"),[Re,pt]=a.useState(8),[Ie,Ke]=a.useState(!1),[Le,ze]=a.useState(!1),Ne=a.useCallback(async t=>{const s=await fetch(`${Q}/dataset/probe`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t})});if(!s.ok){const n=await s.json();throw new Error(n.detail||`HTTP ${s.status}`)}return s.json()},[]),K=a.useCallback(async(t,s)=>{const n={path:t};s&&(n.dataset_path=s);const r=await fetch(`${Q}/dataset/load`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){const h=await r.json();throw new Error(h.detail||`HTTP ${r.status}`)}return{...await r.json(),filePath:t}},[]),L=a.useCallback(async(t=!1,s=0,n=100)=>{const r=new URLSearchParams({log_scale:String(t),contrast_min:String(s),contrast_max:String(n)}),c=await fetch(`${Q}/dataset/diffraction/mean?${r}`);if(!c.ok){const h=await c.json();throw new Error(h.detail||`HTTP ${c.status}`)}return c.json()},[]),Qe=a.useCallback(async(t=!1,s=0,n=100)=>{const r=new URLSearchParams({log_scale:String(t),contrast_min:String(s),contrast_max:String(n)}),c=await fetch(`${Q}/dataset/diffraction/max?${r}`);if(!c.ok){const h=await c.json();throw new Error(h.detail||`HTTP ${c.status}`)}return c.json()},[]),O=a.useCallback(async(t="bf",s=0,n=20,r=!1,c=0,h=100)=>{const u=new URLSearchParams({type:t,inner:String(s),outer:String(n),log_scale:String(r),contrast_min:String(c),contrast_max:String(h)}),g=await fetch(`${Q}/dataset/virtual-image?${u}`);if(!g.ok){const C=await g.json();throw new Error(C.detail||`HTTP ${g.status}`)}return g.json()},[]),he=a.useCallback(async(t,s,n=!1,r=0,c=100)=>{const h=new URLSearchParams({x:String(t),y:String(s),log_scale:String(n),contrast_min:String(r),contrast_max:String(c)}),u=await fetch(`${Q}/dataset/diffraction?${h}`);if(!u.ok){const g=await u.json();throw new Error(g.detail||`HTTP ${u.status}`)}return u.json()},[]),ke=a.useCallback(async(t,s,n,r=!1,c=0,h=100)=>{const u=await fetch(`${Q}/dataset/diffraction/region`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:t,region_type:s,points:n,log_scale:r,contrast_min:c,contrast_max:h})});if(!u.ok){const g=await u.json();throw new Error(g.detail||`HTTP ${u.status}`)}return u.json()},[]),z=a.useCallback(t=>{const s=Be.current;if(!s||!M)return null;const n=s.getBoundingClientRect(),r=M.width/M.height,c=n.width/n.height;let h,u,g,C;r>c?(h=n.width,u=n.width/r,g=0,C=(n.height-u)/2):(u=n.height,h=n.height*r,g=(n.width-h)/2,C=0);const fe=t.clientX-n.left,_e=t.clientY-n.top;if(fe<g||fe>g+h||_e<C||_e>C+u)return null;const Tt=(fe-g)/h*M.width,At=(_e-C)/u*M.height;return[Tt,At]},[M]),mt=a.useCallback(t=>{const s=z(t);if(!s)return;const[n,r]=s;$&&(xe(!0),Z([[n,r]]),t.preventDefault())},[z,$]),xt=a.useCallback(t=>{if(!se)return;const s=z(t);if(!s)return;const[n,r]=s;if($==="lasso")Z(c=>[...c,[n,r]]);else if($==="ellipse"){const[c,h]=j[0],u=Math.sqrt((n-c)**2+(r-h)**2);Z(g=>[g[0],[c+u,h]])}else Z(c=>[c[0],[n,r]])},[se,z,$,j]),bt=a.useCallback(async t=>{if(!se)return;const s=z(t);if(!s){xe(!1),Z([]);return}const[n,r]=s;xe(!1);let c=[],h="rectangle";if($==="rectangle")j.length>=1&&(c=[j[0],[n,r]],h="rectangle");else if($==="ellipse"){if(j.length>=1){const[g,C]=j[0],fe=Math.sqrt((n-g)**2+(r-C)**2);c=[j[0],[g+fe,C]],h="ellipse"}}else $==="lasso"&&(c=[...j,[n,r]],h="polygon");if(Z([]),c.length<2||$==="lasso"&&c.length<3)return;if($!=="lasso"){const g=Math.abs(c[1][0]-c[0][0]),C=Math.abs(c[1][1]-c[0][1]);if(g<2&&C<2)return}if(re({type:h,points:c}),B!=="live"){const g=B;try{const C=await ke(g,h,c,x,f,p);G(C)}catch(C){console.error("Failed to fetch region diffraction:",C)}}},[se,z,$,j,B,ke,x,f,p]),gt=a.useCallback(async t=>{if(B!=="live")return;const s=z(t);if(!s)return;const[n,r]=s.map(Math.round);Ce({x:n,y:r});try{const c=await he(n,r,x,f,p);le(c)}catch(c){console.error("Failed to fetch diffraction pattern:",c)}},[z,B,he,x,f,p]),Oe=a.useCallback(()=>{re(null),G(null)},[]);a.useEffect(()=>{const t=s=>{s.key==="Escape"&&d&&Oe()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[d,Oe]),a.useEffect(()=>{window.electronAPI.updateClickedPosition(y)},[y]),a.useEffect(()=>{window.electronAPI.updateSelection(d)},[d]);const jt=a.useCallback(async t=>{if(Se(t),t==="live"){G(null),Le||re(null);return}if(d)try{const s=await ke(t,d.type,d.points,x,f,p);G(s)}catch(s){console.error("Failed to fetch region diffraction:",s),G(null)}else if(G(null),t==="mean"){if(!De)try{const s=await L(x,f,p);pe(s)}catch(s){console.error("Failed to fetch mean diffraction:",s)}}else if(t==="max"&&!$e)try{const s=await Qe(x,f,p);me(s)}catch(s){console.error("Failed to fetch max diffraction:",s)}},[d,De,$e,L,Qe,ke,x,f,p,Le]),Ze=a.useCallback(async t=>{w(t),v(null),Y(null),H(null),pe(null),me(null),Se("live"),Ce(null),le(null),re(null),G(null),m(null),S(!1),J(null),q(null),b(!0);try{const s=await Ne(t),n=i==="none"?"bf":i,r=i==="bf"||i==="none"?0:i==="abf"?F:T,c=i==="bf"||i==="none"?I:i==="abf"?E:A;if(s.type==="single"){const h=await K(t);v(h);const[u,g]=await Promise.all([L(x,f,p),O(n,r,c,x,f,p)]);Y(u),H(g)}else if(s.type==="hdf5_tree"){J(s),W(s.datasets),_(t);const h=s.datasets.filter(u=>u.is_4d);if(h.length===1){q(h[0].path);const u=await K(t,h[0].path);v(u);const[g,C]=await Promise.all([L(x,f,p),O(n,r,c,x,f,p)]);Y(g),H(C),q(null)}else if(s.datasets.length===1){q(s.datasets[0].path);const u=await K(t,s.datasets[0].path);v(u);const[g,C]=await Promise.all([L(x,f,p),O(n,r,c,x,f,p)]);Y(g),H(C),q(null)}else h.length===0&&s.datasets.length>0}}catch(s){m(s instanceof Error?s.message:"Failed to load dataset"),q(null)}finally{b(!1)}},[Ne,K,L,O,x,f,p,i,I,F,E,T,A]),wt=a.useCallback(async t=>{if(D){S(!1),b(!0),m(null),Y(null),H(null);try{const s=await K(D,t);v(s);const n=i==="none"?"bf":i,r=i==="bf"||i==="none"?0:i==="abf"?F:T,c=i==="bf"||i==="none"?I:i==="abf"?E:A,[h,u]=await Promise.all([L(x,f,p),O(n,r,c,x,f,p)]);Y(h),H(u)}catch(s){m(s instanceof Error?s.message:"Failed to load dataset")}finally{b(!1),_(null),W([])}}},[D,K,L,O,x,f,p,i,I,F,E,T,A]),vt=a.useCallback(async t=>{if(l){b(!0),q(t),m(null),Y(null),H(null),pe(null),me(null),Se("live"),Ce(null),le(null),re(null),G(null);try{const s=await K(l,t);v(s);const n=i==="none"?"bf":i,r=i==="bf"||i==="none"?0:i==="abf"?F:T,c=i==="bf"||i==="none"?I:i==="abf"?E:A,[h,u]=await Promise.all([L(x,f,p),O(n,r,c,x,f,p)]);Y(h),H(u)}catch(s){m(s instanceof Error?s.message:"Failed to load dataset")}finally{b(!1),q(null)}}},[l,K,L,O,x,f,p,i,I,F,E,T,A]),Nt=a.useCallback(async()=>{if(l){b(!0),m(null);try{const t=await Ne(l);t.type==="hdf5_tree"&&(J(t),W(t.datasets))}catch(t){m(t instanceof Error?t.message:"Failed to probe file")}finally{b(!1)}}},[l,Ne]),U=a.useCallback(()=>i==="none"||i==="bf"?{inner:0,outer:I}:i==="abf"?{inner:F,outer:E}:{inner:T,outer:A},[i,I,F,E,T,A]),ue=a.useCallback(()=>i==="none"?"bf":i,[i]),kt=a.useCallback(()=>{if(de!=="auto"){const s={yellow:{fill:"rgba(255, 220, 0, VAR)",stroke:"rgba(255, 220, 0, 0.8)"},cyan:{fill:"rgba(0, 162, 255, VAR)",stroke:"rgba(0, 162, 255, 0.8)"},green:{fill:"rgba(0, 200, 150, VAR)",stroke:"rgba(0, 200, 150, 0.8)"},orange:{fill:"rgba(255, 162, 0, VAR)",stroke:"rgba(255, 162, 0, 0.8)"},magenta:{fill:"rgba(255, 0, 200, VAR)",stroke:"rgba(255, 0, 200, 0.8)"}},n=oe/100*.5;return{fill:s[de].fill.replace("VAR",String(n)),stroke:s[de].stroke}}const t=oe/100*.5;return i==="bf"?{fill:`rgba(0, 162, 255, ${t})`,stroke:"rgba(0, 162, 255, 0.8)"}:i==="abf"?{fill:`rgba(0, 200, 150, ${t})`,stroke:"rgba(0, 200, 150, 0.8)"}:{fill:`rgba(255, 162, 0, ${t})`,stroke:"rgba(255, 162, 0, 0.8)"}},[de,oe,i]);a.useEffect(()=>{if(!o)return;(async()=>{try{const{inner:s,outer:n}=U(),r=ue(),c=await O(r,s,n,x,f,p);if(H(c),y){const h=await he(y.x,y.y,x,f,p);le(h)}else{const h=await L(x,f,p);Y(h)}}catch(s){console.error("Failed to refetch images:",s)}})()},[x,f,p]),a.useEffect(()=>{if(o)return ie.current&&clearTimeout(ie.current),ie.current=setTimeout(async()=>{try{const{inner:t,outer:s}=U(),n=ue(),r=await O(n,t,s,x,f,p);H(r)}catch(t){console.error("Failed to refetch virtual image:",t)}},200),()=>{ie.current&&clearTimeout(ie.current)}},[i,I,F,E,T,A,U,ue,O,x,f,p,o]);const yt=a.useCallback(()=>{S(!1),_(null),W([]),w(null)},[]),Ct=a.useCallback(async()=>{const{inner:t,outer:s}=U(),n={type:i,inner:t,outer:s},r=await window.electronAPI.saveDetectorConfig(n);!r.success&&!r.canceled&&console.error("Failed to save config:",r.error)},[i,U]),St=a.useCallback(async()=>{const t=await window.electronAPI.loadDetectorConfig();if(t.success&&t.config){const{type:s,inner:n,outer:r}=t.config;je(s),s==="none"||s==="bf"?Ue(r):s==="abf"?(Me(n),Fe(r)):s==="adf"&&(Ee(n),Te(r))}else t.canceled||console.error("Failed to load config:",t.error)},[]),Dt=a.useCallback(async()=>{if(!M)return;const t=await window.electronAPI.saveImage(M.image_base64,`virtual-${i}.png`);!t.success&&!t.canceled&&console.error("Failed to export virtual image:",t.error)},[M,i]),$t=a.useCallback(()=>{if(!M)return null;const{inner:t,outer:s}=U(),n=Math.PI*(s*s-t*t);return{area:Math.round(n),inner:t,outer:s}},[M,U]),Pt=a.useCallback(async()=>{Ke(!0);try{const t=await fetch(`${Q}/dataset/preprocess/filter-hot-pixels`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thresh:Re})});if(!t.ok){const u=await t.json();throw new Error(u.detail||`HTTP ${t.status}`)}const{inner:s,outer:n}=U(),r=ue(),[c,h]=await Promise.all([L(x,f,p),O(r,s,n,x,f,p)]);if(Y(c),H(h),pe(null),me(null),y){const u=await he(y.x,y.y,x,f,p);le(u)}}catch(t){console.error("Failed to filter hot pixels:",t),m(t instanceof Error?t.message:"Failed to filter hot pixels")}finally{Ke(!1)}},[Re,U,ue,L,O,he,x,f,p,y]);a.useEffect(()=>(window.electronAPI.onFileSelected(Ze),()=>{window.electronAPI.removeFileSelectedListener()}),[Ze]),a.useEffect(()=>(window.electronAPI.onShowFilterHotPixelsDialog(()=>{o&&(Ve(!1),ge("preprocess"))}),()=>{window.electronAPI.removeFilterHotPixelsDialogListener()}),[o]),a.useEffect(()=>{window.electronAPI.updateDatasetInfo({filePath:l,datasetPath:(o==null?void 0:o.dataset_path)??null,shape:(o==null?void 0:o.shape)??null})},[l,o]),a.useEffect(()=>(window.electronAPI.onWorkflowWindowOpened(()=>{ze(!0)}),window.electronAPI.onWorkflowWindowClosed(()=>{ze(!1)}),()=>{window.electronAPI.removeWorkflowWindowListeners()}),[]);const V=B!=="live"||Le,Mt=a.useCallback(()=>{if(!d)return null;if(d.type==="rectangle"&&d.points.length>=2){const t=Math.abs(d.points[1][0]-d.points[0][0]),s=Math.abs(d.points[1][1]-d.points[0][1]);return`${t.toFixed(0)} Ã— ${s.toFixed(0)} px`}else{if(d.type==="ellipse"&&d.points.length>=2)return`r = ${Math.abs(d.points[1][0]-d.points[0][0]).toFixed(0)} px`;if(d.type==="polygon"&&d.points.length>=3){let t=0;const s=d.points.length;for(let n=0;n<s;n++){const r=(n+1)%s;t+=d.points[n][0]*d.points[r][1],t-=d.points[r][0]*d.points[n][1]}return t=Math.abs(t)/2,`area = ${t.toFixed(0)} pxÂ²`}}return null},[d]),ee=l?l.split("/").pop()??l:null,Ft=()=>{if(!ee)return"No dataset loaded";if(N)return`Loading: ${ee}...`;if(P)return`Selecting dataset from: ${ee}`;if(k)return`Error: ${k}`;if(o){const t=o.shape.join("x");return o.dataset_path?`Loaded: ${ee}:${o.dataset_path} (${t})`:`Loaded: ${ee} (${t})`}return ee},Et=()=>k?"status-bar-file status-error":N||P?"status-bar-file status-loading":o?"status-bar-file status-success":"status-bar-file";return e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"menu-bar"}),e.jsxs("div",{className:"app-body",children:[e.jsx(Ht,{collapsed:X,onToggleCollapse:()=>ye(!X),fileTree:te,selectedDatasetPath:(o==null?void 0:o.dataset_path)??null,isLoading:N,loadingDatasetPath:lt,onDatasetSelect:vt,onRefresh:Nt}),e.jsxs("div",{className:`sidebar ${ce?"collapsed":""}`,children:[e.jsx("button",{className:"sidebar-toggle",onClick:()=>Ve(!ce),title:ce?"Expand sidebar":"Collapse sidebar",children:ce?"â€º":"â€¹"}),!ce&&e.jsxs("div",{className:"sidebar-content",children:[e.jsxs("div",{className:"sidebar-tabs",children:[e.jsx("button",{className:`sidebar-tab ${ae==="display"?"active":""}`,onClick:()=>ge("display"),children:"Display"}),e.jsx("button",{className:`sidebar-tab ${ae==="detector"?"active":""}`,onClick:()=>ge("detector"),children:"Detector"}),e.jsx("button",{className:`sidebar-tab ${ae==="preprocess"?"active":""}`,onClick:()=>ge("preprocess"),children:"Preprocess"})]}),ae==="display"&&e.jsxs("div",{className:"sidebar-tab-content",children:[e.jsx("div",{className:"sidebar-control",children:e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:x,onChange:t=>rt(t.target.checked)}),"Log scale"]})}),e.jsxs("div",{className:"sidebar-control",children:[e.jsx("label",{className:"slider-label",children:"Contrast"}),e.jsxs("div",{className:"contrast-sliders",children:[e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Min"}),e.jsx("input",{type:"range",min:"0",max:"100",value:f,onChange:t=>{const s=Number(t.target.value);Ye(s),s>=p&&Xe(Math.min(100,s+1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:f})]}),e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Max"}),e.jsx("input",{type:"range",min:"0",max:"100",value:p,onChange:t=>{const s=Number(t.target.value);Xe(s),s<=f&&Ye(Math.max(0,s-1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:p})]})]})]})]}),ae==="detector"&&e.jsxs("div",{className:"sidebar-tab-content",children:[e.jsx("div",{className:"sidebar-control",children:e.jsxs("div",{className:"radio-group detector-radio-group",children:[e.jsxs("label",{className:"radio-label",title:"Bright Field - center disk",children:[e.jsx("input",{type:"radio",name:"detector",value:"bf",checked:i==="bf",onChange:()=>je("bf")}),"BF"]}),e.jsxs("label",{className:"radio-label",title:"Annular Bright Field - just outside BF",children:[e.jsx("input",{type:"radio",name:"detector",value:"abf",checked:i==="abf",onChange:()=>je("abf")}),"ABF"]}),e.jsxs("label",{className:"radio-label",title:"Annular Dark Field - outer ring",children:[e.jsx("input",{type:"radio",name:"detector",value:"adf",checked:i==="adf",onChange:()=>je("adf")}),"ADF"]})]})}),i==="bf"&&e.jsx("div",{className:"sidebar-control",children:e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Radius"}),e.jsx("input",{type:"range",min:"1",max:"100",value:I,onChange:t=>Ue(Number(t.target.value)),className:"slider"}),e.jsx("span",{className:"slider-value",children:I})]})}),i==="abf"&&e.jsx("div",{className:"sidebar-control",children:e.jsxs("div",{className:"contrast-sliders",children:[e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Inner"}),e.jsx("input",{type:"range",min:"0",max:"100",value:F,onChange:t=>{const s=Number(t.target.value);Me(s),s>=E&&Fe(Math.min(100,s+1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:F})]}),e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Outer"}),e.jsx("input",{type:"range",min:"1",max:"100",value:E,onChange:t=>{const s=Number(t.target.value);Fe(s),s<=F&&Me(Math.max(0,s-1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:E})]})]})}),i==="adf"&&e.jsx("div",{className:"sidebar-control",children:e.jsxs("div",{className:"contrast-sliders",children:[e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Inner"}),e.jsx("input",{type:"range",min:"0",max:"100",value:T,onChange:t=>{const s=Number(t.target.value);Ee(s),s>=A&&Te(Math.min(100,s+1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:T})]}),e.jsxs("div",{className:"slider-row",children:[e.jsx("span",{className:"slider-label-small",children:"Outer"}),e.jsx("input",{type:"range",min:"1",max:"100",value:A,onChange:t=>{const s=Number(t.target.value);Te(s),s<=T&&Ee(Math.max(0,s-1))},className:"slider"}),e.jsx("span",{className:"slider-value",children:A})]})]})})]}),ae==="preprocess"&&e.jsx("div",{className:"sidebar-tab-content",children:e.jsxs("div",{className:"sidebar-control",children:[e.jsx("label",{className:"sidebar-control-label",children:"Filter Hot Pixels"}),e.jsx("p",{className:"sidebar-control-description",children:"Remove anomalously bright pixels from the dataset."}),e.jsxs("div",{className:"preprocess-row",children:[e.jsx("label",{className:"slider-label-small",children:"Threshold (Ïƒ)"}),e.jsx("input",{type:"number",className:"preprocess-input",value:Re,onChange:t=>pt(Number(t.target.value)),min:1,max:20,step:.5,disabled:Ie||!o})]}),e.jsx("button",{className:"preprocess-apply-button",onClick:Pt,disabled:Ie||!o,children:Ie?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"loading-spinner"}),"Filtering..."]}):"Apply Filter"})]})})]})]}),e.jsxs("div",{className:"main-content",children:[e.jsxs("div",{className:"panels-area",children:[e.jsxs("div",{className:"panel real-space",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("span",{className:"panel-label",children:"Real Space"}),e.jsxs("div",{className:"selection-tools",children:[e.jsx("button",{className:`selection-tool-btn ${V&&$==="rectangle"?"active":""}`,onClick:()=>Pe("rectangle"),title:"Rectangle selection",children:"â–¢"}),e.jsx("button",{className:`selection-tool-btn ${V&&$==="ellipse"?"active":""}`,onClick:()=>Pe("ellipse"),title:"Circle selection",children:"â—¯"}),e.jsx("button",{className:`selection-tool-btn ${V&&$==="lasso"?"active":""}`,onClick:()=>Pe("lasso"),title:"Lasso selection",children:"âœŽ"}),V&&d&&e.jsx("button",{className:"selection-tool-btn clear-btn",onClick:Oe,title:"Clear selection",children:"âœ•"})]})]}),V&&d&&e.jsx("div",{className:"selection-info-bar",children:e.jsx("span",{className:"selection-attributes",children:Mt()})}),e.jsx("div",{className:"panel-content",children:M&&e.jsxs("div",{className:"panel-image-container",style:{cursor:V&&$?"crosshair":void 0},onMouseDown:V?mt:void 0,onMouseMove:V?xt:void 0,onMouseUp:V?bt:void 0,onMouseLeave:()=>{se&&(xe(!1),Z([]))},children:[e.jsx("img",{ref:Be,className:"panel-image clickable",src:`data:image/png;base64,${M.image_base64}`,alt:"Virtual bright-field image",onClick:gt,draggable:!1}),e.jsxs("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none"},viewBox:`0 0 ${M.width} ${M.height}`,preserveAspectRatio:"xMidYMid meet",children:[V&&d&&e.jsxs(e.Fragment,{children:[d.type==="rectangle"&&d.points.length>=2&&e.jsx("rect",{x:Math.min(d.points[0][0],d.points[1][0]),y:Math.min(d.points[0][1],d.points[1][1]),width:Math.abs(d.points[1][0]-d.points[0][0]),height:Math.abs(d.points[1][1]-d.points[0][1]),fill:"rgba(0, 200, 255, 0.3)",stroke:"rgba(0, 200, 255, 0.9)",strokeWidth:"1.5"}),d.type==="ellipse"&&d.points.length>=2&&e.jsx("circle",{cx:d.points[0][0],cy:d.points[0][1],r:Math.abs(d.points[1][0]-d.points[0][0]),fill:"rgba(0, 200, 255, 0.3)",stroke:"rgba(0, 200, 255, 0.9)",strokeWidth:"1.5"}),d.type==="polygon"&&d.points.length>=3&&e.jsx("polygon",{points:d.points.map(t=>`${t[0]},${t[1]}`).join(" "),fill:"rgba(0, 200, 255, 0.3)",stroke:"rgba(0, 200, 255, 0.9)",strokeWidth:"1.5"})]}),V&&se&&j.length>0&&e.jsxs(e.Fragment,{children:[$==="rectangle"&&j.length>=2&&e.jsx("rect",{x:Math.min(j[0][0],j[1][0]),y:Math.min(j[0][1],j[1][1]),width:Math.abs(j[1][0]-j[0][0]),height:Math.abs(j[1][1]-j[0][1]),fill:"rgba(255, 220, 0, 0.3)",stroke:"rgba(255, 220, 0, 0.9)",strokeWidth:"1.5",strokeDasharray:"4 2"}),$==="ellipse"&&j.length>=2&&e.jsx("circle",{cx:j[0][0],cy:j[0][1],r:Math.abs(j[1][0]-j[0][0]),fill:"rgba(255, 220, 0, 0.3)",stroke:"rgba(255, 220, 0, 0.9)",strokeWidth:"1.5",strokeDasharray:"4 2"}),$==="lasso"&&j.length>=2&&e.jsx("polyline",{points:j.map(t=>`${t[0]},${t[1]}`).join(" "),fill:"none",stroke:"rgba(255, 220, 0, 0.9)",strokeWidth:"1.5",strokeDasharray:"4 2"})]}),B==="live"&&y&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:y.x-4,y1:y.y,x2:y.x+4,y2:y.y,stroke:"#00ff00",strokeWidth:"1"}),e.jsx("line",{x1:y.x,y1:y.y-4,x2:y.x,y2:y.y+4,stroke:"#00ff00",strokeWidth:"1"})]})]})]})})]}),e.jsx("div",{className:"panel-divider"}),e.jsxs("div",{className:"panel reciprocal-space",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("span",{className:"panel-label",children:"Reciprocal Space"}),e.jsxs("div",{className:"diffraction-mode-container",children:[e.jsxs("select",{className:"diffraction-mode-select",value:B,onChange:t=>jt(t.target.value),children:[e.jsx("option",{value:"live",children:"Live"}),e.jsx("option",{value:"mean",children:"Mean"}),e.jsx("option",{value:"max",children:"Max"})]}),B!=="live"&&be&&e.jsx("span",{className:"region-indicator",title:`${be.pixels_in_region} pixels selected`,children:"(region)"})]})]}),e.jsx("div",{className:"panel-content",children:(()=>{let t=null;return B==="live"?t=He||We:B==="mean"?t=be||De||We:B==="max"&&(t=be||$e),t?e.jsxs("div",{className:"panel-image-container",children:[e.jsx("img",{className:"panel-image",src:`data:image/png;base64,${t.image_base64}`,alt:He?"Diffraction pattern":"Mean diffraction pattern"}),e.jsx("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none"},viewBox:`0 0 ${t.width} ${t.height}`,preserveAspectRatio:"xMidYMid meet",children:we&&i!=="none"&&(()=>{const s=kt(),n=t.width/2+Je,r=t.height/2+qe,c="detector-clip";return i==="bf"?e.jsxs(e.Fragment,{children:[e.jsx("defs",{children:e.jsx("clipPath",{id:c,children:e.jsx("rect",{x:"0",y:"0",width:t.width,height:t.height})})}),e.jsx("g",{clipPath:`url(#${c})`,children:e.jsx("circle",{cx:n,cy:r,r:I,fill:s.fill,stroke:s.stroke,strokeWidth:"1"})})]}):i==="abf"?e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("clipPath",{id:c,children:e.jsx("rect",{x:"0",y:"0",width:t.width,height:t.height})}),e.jsxs("mask",{id:"abf-annulus-mask",children:[e.jsx("rect",{width:"100%",height:"100%",fill:"white"}),e.jsx("circle",{cx:n,cy:r,r:F,fill:"black"})]})]}),e.jsxs("g",{clipPath:`url(#${c})`,children:[e.jsx("circle",{cx:n,cy:r,r:E,fill:s.fill,mask:"url(#abf-annulus-mask)"}),e.jsx("circle",{cx:n,cy:r,r:E,fill:"none",stroke:s.stroke,strokeWidth:"1"}),e.jsx("circle",{cx:n,cy:r,r:F,fill:"none",stroke:s.stroke,strokeWidth:"1"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("defs",{children:[e.jsx("clipPath",{id:c,children:e.jsx("rect",{x:"0",y:"0",width:t.width,height:t.height})}),e.jsxs("mask",{id:"adf-annulus-mask",children:[e.jsx("rect",{width:"100%",height:"100%",fill:"white"}),e.jsx("circle",{cx:n,cy:r,r:T,fill:"black"})]})]}),e.jsxs("g",{clipPath:`url(#${c})`,children:[e.jsx("circle",{cx:n,cy:r,r:A,fill:s.fill,mask:"url(#adf-annulus-mask)"}),e.jsx("circle",{cx:n,cy:r,r:A,fill:"none",stroke:s.stroke,strokeWidth:"1"}),e.jsx("circle",{cx:n,cy:r,r:T,fill:"none",stroke:s.stroke,strokeWidth:"1"})]})]})})()})]}):null})()})]})]}),e.jsxs("div",{className:`workflow-panel ${ne?"collapsed":""}`,children:[e.jsxs("div",{className:"workflow-header",children:[ne?e.jsx("div",{className:"workflow-summary",children:ve==="virtual-detector"?e.jsxs("span",{className:"workflow-summary-text",children:["Virtual Detector: ",i==="none"?"None":i==="bf"?`BF (0-${I} px)`:i==="abf"?`ABF (${F}-${E} px)`:`ADF (${T}-${A} px)`]}):e.jsx("span",{className:"workflow-summary-text",children:"Disk Detection: Click to launch workflow"})}):e.jsxs("div",{className:"workflow-tabs",children:[e.jsx("button",{className:`workflow-tab ${ve==="virtual-detector"?"active":""}`,onClick:()=>Ge("virtual-detector"),children:"Virtual Detector"}),e.jsx("button",{className:`workflow-tab ${ve==="disk-detection"?"active":""}`,onClick:()=>Ge("disk-detection"),children:"Disk Detection"})]}),e.jsx("button",{className:"workflow-toggle",onClick:()=>ft(!ne),title:ne?"Expand panel":"Collapse panel",children:ne?"â–²":"â–¼"})]}),!ne&&e.jsx("div",{className:"workflow-content",children:ve==="virtual-detector"?e.jsxs("div",{className:"workflow-tab-content virtual-detector-content",children:[e.jsxs("div",{className:"detector-controls-row",children:[e.jsx("div",{className:"detector-control-group",children:e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:we,onChange:t=>it(t.target.checked),disabled:i==="none"}),"Show overlay"]})}),e.jsxs("div",{className:"detector-control-group",children:[e.jsx("label",{className:"detector-control-label",children:"Opacity"}),e.jsx("input",{type:"range",min:"0",max:"100",value:oe,onChange:t=>ct(Number(t.target.value)),className:"slider detector-slider",disabled:!we||i==="none"}),e.jsxs("span",{className:"detector-control-value",children:[oe,"%"]})]}),e.jsxs("div",{className:"detector-control-group",children:[e.jsx("label",{className:"detector-control-label",children:"Color"}),e.jsxs("select",{className:"detector-select",value:de,onChange:t=>ot(t.target.value),disabled:!we||i==="none",children:[e.jsx("option",{value:"auto",children:"Auto"}),e.jsx("option",{value:"yellow",children:"Yellow"}),e.jsx("option",{value:"cyan",children:"Cyan"}),e.jsx("option",{value:"green",children:"Green"}),e.jsx("option",{value:"orange",children:"Orange"}),e.jsx("option",{value:"magenta",children:"Magenta"})]})]}),e.jsxs("div",{className:"detector-control-group",children:[e.jsx("label",{className:"detector-control-label",children:"Center X"}),e.jsx("input",{type:"number",className:"detector-input",value:Je,onChange:t=>dt(Number(t.target.value)),disabled:i==="none"})]}),e.jsxs("div",{className:"detector-control-group",children:[e.jsx("label",{className:"detector-control-label",children:"Center Y"}),e.jsx("input",{type:"number",className:"detector-input",value:qe,onChange:t=>ht(Number(t.target.value)),disabled:i==="none"})]}),e.jsx("button",{className:`detector-pick-button ${Ae?"active":""}`,onClick:()=>ut(!Ae),disabled:i==="none",title:"Click on diffraction pattern to set center",children:Ae?"Cancel":"Pick"})]}),e.jsxs("div",{className:"detector-actions-row",children:[e.jsxs("div",{className:"config-buttons",children:[e.jsx("button",{className:"config-button",onClick:Ct,children:"Save Config"}),e.jsx("button",{className:"config-button",onClick:St,children:"Load Config"})]}),e.jsx("button",{className:"detector-export-button",onClick:Dt,disabled:!M,children:"Export Image"}),(()=>{const t=$t();return!t||i==="none"?null:e.jsxs("span",{className:"detector-stats",children:["Area: ",t.area," px | Range: ",t.inner,"-",t.outer," px"]})})()]})]}):e.jsx("div",{className:"workflow-tab-content disk-detection-content",children:e.jsxs("div",{className:"disk-detection-launch",children:[e.jsx("p",{className:"disk-detection-description",children:"Disk detection requires a dedicated workflow window with more screen space for template setup and parameter tuning."}),e.jsx("button",{className:"launch-workflow-button",onClick:()=>{window.electronAPI.openWorkflowWindow("disk-detection")},disabled:!o,children:"Launch Disk Detection"}),!o&&e.jsx("p",{className:"disk-detection-warning",children:"Load a dataset first to enable disk detection."})]})})})]})]})]}),e.jsxs("div",{className:"status-bar",children:[e.jsx("span",{className:Et(),children:Ft()}),y&&e.jsxs("span",{className:"status-bar-position",children:["Position: (",y.x,", ",y.y,")"]}),e.jsx(_t,{className:"status-bar-backend"})]}),e.jsx(Bt,{isOpen:P,datasets:R,filename:ee??"",onSelect:wt,onCancel:yt})]})}Rt.createRoot(document.getElementById("root")).render(e.jsx(It.StrictMode,{children:e.jsx(Vt,{})}));
